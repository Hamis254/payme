
> payme@1.0.0 test
> jest

PASS tests/stock.test.js
  Stock Service
    Product Management
      Î“ÃªÃœ should create a product (619 ms)
      Î“ÃªÃœ should get products for a business (9 ms)
      Î“ÃªÃœ should get product by ID (4 ms)
      Î“ÃªÃœ should update product (3 ms)
      Î“ÃªÃœ should handle product not found (124 ms)
    Stock Operations
      Î“ÃªÃœ should add stock batch (3 ms)
      Î“ÃªÃœ should deduct stock (2 ms)
      Î“ÃªÃœ should check stock availability (3 ms)
      Î“ÃªÃœ should deduct stock using FIFO (5 ms)
      Î“ÃªÃœ should record stock adjustment (2 ms)
    Inventory Reporting
      Î“ÃªÃœ should get inventory for product (2 ms)
      Î“ÃªÃœ should get full inventory for business (2 ms)
      Î“ÃªÃœ should calculate inventory value (1 ms)
    Error Handling
      Î“ÃªÃœ should handle insufficient stock (1 ms)
      Î“ÃªÃœ should validate product ownership (18 ms)
      Î“ÃªÃœ should validate business ownership on creation (5 ms)
    Batch Tracking
      Î“ÃªÃœ should track stock batches (2 ms)
      Î“ÃªÃœ should track FIFO costs (2 ms)

PASS tests/wallet.test.js
  Wallet Service
    Token Packages
      Î“ÃªÃœ should return available token packages (1390 ms)
      Î“ÃªÃœ should calculate correct savings for packages (3 ms)
      Î“ÃªÃœ should apply percentage discount correctly (7 ms)
    Token Packages Configuration
      Î“ÃªÃœ should have correct token package pricing (5 ms)
      Î“ÃªÃœ should have increasing discount for larger packages (7 ms)

[33mwarn[39m: Callback timestamp is in the future {"age":-18490073014023,"service":"payme","timestamp":"2026-02-03T14:48:25.979Z"}
[32minfo[39m: User test@example.com created successfully {"service":"payme","timestamp":"2026-02-03T14:48:25.972Z"}
[31merror[39m: Error creating the user: Error: User with this email already exists {"service":"payme","timestamp":"2026-02-03T14:48:26.003Z"}
PASS tests/users.test.js
  Users Service
    Exports Validation
      Î“ÃªÃœ should export getAllUsers function (657 ms)
      Î“ÃªÃœ should export getUserById function (12 ms)
      Î“ÃªÃœ should export updateUser function (5 ms)
      Î“ÃªÃœ should export deleteUser function (10 ms)
      Î“ÃªÃœ should have exactly 4 exports (5 ms)
    Function Types
      Î“ÃªÃœ getAllUsers should be async (416 ms)
      Î“ÃªÃœ getUserById should be async (11 ms)
      Î“ÃªÃœ updateUser should be async (9 ms)
      Î“ÃªÃœ deleteUser should be async (8 ms)
    getAllUsers Function
      Î“ÃªÃœ should be callable with no parameters (2 ms)
      Î“ÃªÃœ should return a Promise (13 ms)
      Î“ÃªÃœ should return array of users (17 ms)
      Î“ÃªÃœ should include user fields in result (4 ms)
    getUserById Function
      Î“ÃªÃœ should accept id parameter (2 ms)
      Î“ÃªÃœ should return single user object (1 ms)
      Î“ÃªÃœ should include user fields in result (1 ms)
      Î“ÃªÃœ should handle numeric id (18 ms)
      Î“ÃªÃœ should throw error when user not found (7 ms)
    updateUser Function
      Î“ÃªÃœ should accept id and updates parameters (25 ms)
      Î“ÃªÃœ should allow updating name (28 ms)
      Î“ÃªÃœ should allow updating email (10 ms)
      Î“ÃªÃœ should allow updating phone_number (80 ms)
      Î“ÃªÃœ should allow updating role (22 ms)
      Î“ÃªÃœ should accept multiple update fields (31 ms)
      Î“ÃªÃœ should return updated user object (3 ms)
      Î“ÃªÃœ should update updated_at timestamp (42 ms)
      Î“ÃªÃœ should throw error when user not found (7 ms)
      Î“ÃªÃœ should validate duplicate email not allowed (4 ms)
      Î“ÃªÃœ should validate duplicate phone not allowed (4 ms)
      Î“ÃªÃœ should allow updating same email (2 ms)
      Î“ÃªÃœ should allow updating same phone (1 ms)
    deleteUser Function
      Î“ÃªÃœ should accept id parameter (1 ms)
      Î“ÃªÃœ should return deleted user object (1 ms)
      Î“ÃªÃœ should throw error when user not found (1 ms)
      Î“ÃªÃœ should check user exists before deleting (1 ms)
    Service Structure
      Î“ÃªÃœ should be importable from #services/users.service.js (1 ms)
      Î“ÃªÃœ should be a valid ES module (1 ms)
    User Fields
      Î“ÃªÃœ should handle user id field (1 ms)
      Î“ÃªÃœ should handle user email field (3 ms)
      Î“ÃªÃœ should handle user name field (20 ms)
      Î“ÃªÃœ should handle user phone_number field (7 ms)
      Î“ÃªÃœ should handle user role field (4 ms)
      Î“ÃªÃœ should handle user created_at field (1 ms)
      Î“ÃªÃœ should handle user updated_at field (6 ms)
    User Roles
      Î“ÃªÃœ should support admin role (1 ms)
      Î“ÃªÃœ should support user role (2 ms)
      Î“ÃªÃœ should support guest role (7 ms)
    Email Validation
      Î“ÃªÃœ should detect duplicate email on update (1 ms)
      Î“ÃªÃœ should reject duplicate email with error message
      Î“ÃªÃœ should allow email change to new address (6 ms)
    Phone Validation
      Î“ÃªÃœ should detect duplicate phone_number on update (1 ms)
      Î“ÃªÃœ should reject duplicate phone with error message (2 ms)
      Î“ÃªÃœ should allow phone change to new number (3 ms)
      Î“ÃªÃœ should support Kenyan phone format (25 ms)
    Error Handling
      Î“ÃªÃœ getAllUsers should throw on database error (1 ms)
      Î“ÃªÃœ getUserById should throw on database error (22 ms)
      Î“ÃªÃœ updateUser should throw on database error (1 ms)
      Î“ÃªÃœ deleteUser should throw on database error (1 ms)
      Î“ÃªÃœ should log all operations (2 ms)
    Database Operations
      Î“ÃªÃœ getAllUsers should query users table (1 ms)
      Î“ÃªÃœ getUserById should query users table with id filter (1 ms)
      Î“ÃªÃœ updateUser should query users table to verify existence (1 ms)
      Î“ÃªÃœ updateUser should check for duplicate email (1 ms)
      Î“ÃªÃœ updateUser should check for duplicate phone (1 ms)
      Î“ÃªÃœ updateUser should update users table
      Î“ÃªÃœ deleteUser should query users table to verify existence (1 ms)
      Î“ÃªÃœ deleteUser should delete from users table
    User Creation Workflow
      Î“ÃªÃœ should capture user id on creation
      Î“ÃªÃœ should capture user email on creation
      Î“ÃªÃœ should capture user created_at on creation (1 ms)
      Î“ÃªÃœ should initialize user updated_at on creation (1 ms)
    CRUD Operations Completeness
      Î“ÃªÃœ should support Create via initial user creation (1 ms)
      Î“ÃªÃœ should support Read with getAllUsers (1 ms)
      Î“ÃªÃœ should support Read with getUserById (3 ms)
      Î“ÃªÃœ should support Update with updateUser (1 ms)
      Î“ÃªÃœ should support Delete with deleteUser (5 ms)
    Immutable Fields
      Î“ÃªÃœ should preserve user id on update (1 ms)
      Î“ÃªÃœ should preserve user created_at on update (3 ms)
      Î“ÃªÃœ should update updated_at timestamp on update (1 ms)

[31merror[39m: Token purchase STK push failed {"error":"Missing required parameters: phone, amount, accountReference","service":"payme","timestamp":"2026-02-03T14:48:26.000Z"}
[31merror[39m: Token purchase STK push failed {"error":"Missing required parameters: phone, amount, accountReference","service":"payme","timestamp":"2026-02-03T14:48:26.041Z"}
[31merror[39m: Token purchase STK push failed {"error":"Missing required parameters: phone, amount, accountReference","service":"payme","timestamp":"2026-02-03T14:48:26.045Z"}
[31merror[39m: Error authenticating user: Error: User not found {"service":"payme","timestamp":"2026-02-03T14:48:26.095Z"}
PASS tests/sales.test.js (5.061 s)
  Sales Service
    Exports Validation
      Î“ÃªÃœ should export validateAndCalculateCart function (787 ms)
      Î“ÃªÃœ should export createSale function (2 ms)
      Î“ÃªÃœ should export updateSaleStatus function (2 ms)
      Î“ÃªÃœ should export getSalesForBusiness function (2 ms)
      Î“ÃªÃœ should export getSaleById function (2 ms)
      Î“ÃªÃœ should have exactly 5 exports (2 ms)
    Function Types
      Î“ÃªÃœ validateAndCalculateCart should be async (325 ms)
      Î“ÃªÃœ createSale should be async (12 ms)
      Î“ÃªÃœ updateSaleStatus should be async (21 ms)
      Î“ÃªÃœ getSalesForBusiness should be async (12 ms)
      Î“ÃªÃœ getSaleById should be async (17 ms)
    Function Parameters - validateAndCalculateCart
      Î“ÃªÃœ should accept userId parameter (1 ms)
      Î“ÃªÃœ should accept businessId parameter (1 ms)
      Î“ÃªÃœ should accept items array parameter (3 ms)
      Î“ÃªÃœ should handle empty items array (13 ms)
      Î“ÃªÃœ should handle items with product_id and quantity (11 ms)
    Function Parameters - createSale
      Î“ÃªÃœ should accept userId, businessId, items, and paymentMode (1 ms)
      Î“ÃªÃœ should accept cash payment mode (14 ms)
      Î“ÃªÃœ should accept mpesa payment mode (30 ms)
      Î“ÃªÃœ should support optional options parameter (14 ms)
    Function Parameters - updateSaleStatus
      Î“ÃªÃœ should accept saleId and status parameters (2 ms)
      Î“ÃªÃœ should accept completed status (12 ms)
      Î“ÃªÃœ should accept pending status (29 ms)
      Î“ÃªÃœ should accept failed status (76 ms)
      Î“ÃªÃœ should support optional mpesaData parameter (29 ms)
    Function Parameters - getSalesForBusiness
      Î“ÃªÃœ should accept userId and businessId parameters (5 ms)
      Î“ÃªÃœ should support optional options parameter (72 ms)
      Î“ÃªÃœ should work without options parameter (11 ms)
    Function Parameters - getSaleById
      Î“ÃªÃœ should accept userId and saleId parameters (3 ms)
      Î“ÃªÃœ should handle numeric saleId (13 ms)
    Service Structure
      Î“ÃªÃœ should be importable from #services/sales.service.js path (15 ms)
      Î“ÃªÃœ should be a valid ES module (3 ms)
    Payment Mode Support
      Î“ÃªÃœ should support cash payment mode for sales (12 ms)
      Î“ÃªÃœ should support mpesa payment mode for sales (30 ms)
      Î“ÃªÃœ updateSaleStatus should handle mpesa transaction data (5 ms)
    Stock Management Integration
      Î“ÃªÃœ validateAndCalculateCart should check stock availability (1 ms)
      Î“ÃªÃœ createSale should deduct stock using FIFO (1 ms)
      Î“ÃªÃœ createSale should calculate profit based on FIFO cost (1 ms)
    Data Validation
      Î“ÃªÃœ validateAndCalculateCart should verify business ownership (4 ms)
      Î“ÃªÃœ validateAndCalculateCart should verify product belongs to business (1 ms)
      Î“ÃªÃœ getSalesForBusiness should require valid userId (1 ms)
      Î“ÃªÃœ getSaleById should require valid userId and saleId (1 ms)
    Return Value Structure
      Î“ÃªÃœ validateAndCalculateCart should return object with items and amounts (2 ms)
      Î“ÃªÃœ createSale should return object with sale, items, and summary (1 ms)
      Î“ÃªÃœ updateSaleStatus should return updated sale object (2 ms)
      Î“ÃªÃœ getSalesForBusiness should return array of sales (3 ms)
      Î“ÃªÃœ getSaleById should return single sale object (1 ms)
    Customer Information
      Î“ÃªÃœ createSale should support walk_in customer type (3 ms)
      Î“ÃªÃœ createSale should support registered customer type (1 ms)
      Î“ÃªÃœ createSale should capture M-Pesa sender phone (1 ms)
      Î“ÃªÃœ updateSaleStatus should update M-Pesa sender details (2 ms)
    Sale Status Workflow
      Î“ÃªÃœ should support cash sales with immediate completion (1 ms)
      Î“ÃªÃœ should support mpesa sales with pending status (2 ms)
      Î“ÃªÃœ should allow status update to completed (1 ms)
      Î“ÃªÃœ should allow status update to failed (1 ms)
    Profit Calculation
      Î“ÃªÃœ createSale should calculate individual item profit (1 ms)
      Î“ÃªÃœ createSale should calculate total profit (3 ms)
      Î“ÃªÃœ createSale should calculate profit margin percent (1 ms)
    Sale Items Tracking
      Î“ÃªÃœ createSale should track product name for each item (16 ms)
      Î“ÃªÃœ createSale should track quantity for each item (2 ms)
      Î“ÃªÃœ createSale should track unit and total price for each item (1 ms)
      Î“ÃªÃœ createSale should track unit cost for each item (from FIFO)
    Error Handling
      Î“ÃªÃœ validateAndCalculateCart should throw on invalid business (1 ms)
      Î“ÃªÃœ validateAndCalculateCart should throw on missing product (4 ms)
      Î“ÃªÃœ validateAndCalculateCart should throw on insufficient stock (9 ms)
      Î“ÃªÃœ should handle sale creation errors gracefully (3 ms)
    Database Integration
      Î“ÃªÃœ validateAndCalculateCart should query businesses table (1 ms)
      Î“ÃªÃœ validateAndCalculateCart should query products table
      Î“ÃªÃœ createSale should insert into sales table (1 ms)
      Î“ÃªÃœ createSale should insert into saleItems table (4 ms)
      Î“ÃªÃœ createSale should insert into stockMovements table for each FIFO batch (1 ms)

PASS tests/auth.test.js (5.123 s)
  Authentication Service
    Password Management
      Î“ÃªÃœ should hash password (1546 ms)
      Î“ÃªÃœ should compare password with hash (45 ms)
      Î“ÃªÃœ should reject incorrect password (2 ms)
    User Creation
      Î“ÃªÃœ should create a new user (36 ms)
      Î“ÃªÃœ should reject duplicate email (94 ms)
    User Authentication
      Î“ÃªÃœ should reject non-existent user (37 ms)

C:\Users\kkc12\payme\node_modules\drizzle-orm\pg-core\session.cjs:66
        throw new import_errors.DrizzleQueryError(queryString, params, e);
              ^

DrizzleQueryError: Failed query: select "id", "user_id", "name", "location", "location_description", "payment_method", "payment_identifier", "verified", "google_sheets_spreadsheet_id", "google_sheets_enabled", "google_sheets_auth_token", "created_at", "updated_at" from "businesses" where ("businesses"."id" = $1 and "businesses"."user_id" = $2) limit $3
params: 1,1,1
    at NeonHttpPreparedQuery.queryWithCache (C:\Users\kkc12\payme\node_modules\src\pg-core\session.ts:73:11)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at NeonHttpPreparedQuery.execute (C:\Users\kkc12\payme\node_modules\src\neon-http\session.ts:83:18)
    at validateAndCalculateCart (C:\Users\kkc12\payme\src\services\sales.service.js:19:24) {
  query: 'select "id", "user_id", "name", "location", "location_description", "payment_method", "payment_identifier", "verified", "google_sheets_spreadsheet_id", "google_sheets_enabled", "google_sheets_auth_token", "created_at", "updated_at" from "businesses" where ("businesses"."id" = $1 and "businesses"."user_id" = $2) limit $3',
  params: [ 1, 1, 1 ],
  cause: NeonDbError: Error connecting to database: TypeError: fetch failed
      at mr.execute (C:\Users\kkc12\payme\node_modules\@neondatabase\serverless\index.js:1294:95)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)
      at C:\Users\kkc12\payme\node_modules\src\neon-http\session.ts:84:11
      at NeonHttpPreparedQuery.queryWithCache (C:\Users\kkc12\payme\node_modules\src\pg-core\session.ts:71:12)
      at NeonHttpPreparedQuery.execute (C:\Users\kkc12\payme\node_modules\src\neon-http\session.ts:83:18)
      at validateAndCalculateCart (C:\Users\kkc12\payme\src\services\sales.service.js:19:24) {
    severity: undefined,
    code: undefined,
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined,
    sourceError: TypeError: fetch failed
        at node:internal/deps/undici/undici:13510:13
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at mr.execute (C:\Users\kkc12\payme\node_modules\@neondatabase\serverless\index.js:1294:4)
        at C:\Users\kkc12\payme\node_modules\src\neon-http\session.ts:84:11
        at NeonHttpPreparedQuery.queryWithCache (C:\Users\kkc12\payme\node_modules\src\pg-core\session.ts:71:12)
        at NeonHttpPreparedQuery.execute (C:\Users\kkc12\payme\node_modules\src\neon-http\session.ts:83:18)
        at validateAndCalculateCart (C:\Users\kkc12\payme\src\services\sales.service.js:19:24) {
      [cause]: AggregateError: 
          at internalConnectMultiple (node:net:1134:18)
          at afterConnectMultiple (node:net:1715:7) {
        code: 'ECONNREFUSED',
        [errors]: [
          Error: connect ECONNREFUSED ::1:443
              at createConnectionError (node:net:1678:14)
              at afterConnectMultiple (node:net:1708:16) {
            errno: -4078,
            code: 'ECONNREFUSED',
            syscall: 'connect',
            address: '::1',
            port: 443
          },
          Error: connect ECONNREFUSED 127.0.0.1:443
              at createConnectionError (node:net:1678:14)
              at afterConnectMultiple (node:net:1708:16) {
            errno: -4078,
            code: 'ECONNREFUSED',
            syscall: 'connect',
            address: '127.0.0.1',
            port: 443
          }
        ]
      }
    }
  }
}

Node.js v22.17.0
PASS tests/higherPurchase.test.js
  Higher Purchase Service
    Module Exports
      Î“ÃªÃœ should export createAgreement function (675 ms)
      Î“ÃªÃœ should export getAgreementById function (2 ms)
      Î“ÃªÃœ should export listAgreements function (1 ms)
      Î“ÃªÃœ should export recordInstallmentPayment function (1 ms)
      Î“ÃªÃœ should export getOverdueInstallments function (1 ms)
      Î“ÃªÃœ should export getUpcomingInstallments function (1 ms)
      Î“ÃªÃœ should export getAgreementSummary function (1 ms)
      Î“ÃªÃœ should export getStatusDistribution function (1 ms)
      Î“ÃªÃœ should export updateAgreementStatus function (2 ms)
      Î“ÃªÃœ should export getPaymentHistory function (1 ms)
      Î“ÃªÃœ should export getCollectionRate function (1 ms)
      Î“ÃªÃœ should export getRevenueByFrequency function (5 ms)
    Function Signatures
      Î“ÃªÃœ createAgreement should be async (1 ms)
      Î“ÃªÃœ getAgreementById should be async (2 ms)
      Î“ÃªÃœ listAgreements should be async (1 ms)
      Î“ÃªÃœ recordInstallmentPayment should be async (2 ms)
      Î“ÃªÃœ getOverdueInstallments should be async
      Î“ÃªÃœ getUpcomingInstallments should be async (1 ms)
      Î“ÃªÃœ getAgreementSummary should be async (3 ms)
      Î“ÃªÃœ getStatusDistribution should be async (24 ms)
      Î“ÃªÃœ updateAgreementStatus should be async (1 ms)
      Î“ÃªÃœ getPaymentHistory should be async (2 ms)
      Î“ÃªÃœ getCollectionRate should be async (1 ms)
      Î“ÃªÃœ getRevenueByFrequency should be async (32 ms)
    createAgreement Parameters
      Î“ÃªÃœ should accept data object with saleId (2 ms)
      Î“ÃªÃœ should accept data object with accountId (2 ms)
      Î“ÃªÃœ should accept data object with businessId (1 ms)
      Î“ÃªÃœ should accept data object with principalAmount (1 ms)
      Î“ÃªÃœ should accept data object with interestRate (2 ms)
      Î“ÃªÃœ should accept data object with downPayment (2 ms)
      Î“ÃªÃœ should accept data object with installmentAmount (1 ms)
      Î“ÃªÃœ should accept data object with installmentFrequency (1 ms)
      Î“ÃªÃœ should accept data object with numberOfInstallments (1 ms)
      Î“ÃªÃœ should accept data object with agreementDate (1 ms)
      Î“ÃªÃœ should accept data object with firstPaymentDate (1 ms)
      Î“ÃªÃœ should accept data object with finalPaymentDate (1 ms)
      Î“ÃªÃœ should accept optional lateFeeAmount
      Î“ÃªÃœ should accept optional gracePeriodDays (1 ms)
      Î“ÃªÃœ should accept optional termsAndConditions (1 ms)
      Î“ÃªÃœ should accept optional notes (2 ms)
      Î“ÃªÃœ should accept optional createdBy (1 ms)
    Calculation
      Î“ÃªÃœ should calculate totalAmount from principal and interest (2 ms)
      Î“ÃªÃœ should calculate amountFinanced as totalAmount minus downPayment (2 ms)
      Î“ÃªÃœ should use atomic transaction for agreement and installments (1 ms)
      Î“ÃªÃœ should create installments for each period (5 ms)
      Î“ÃªÃœ should initialize status as active (1 ms)
      Î“ÃªÃœ should initialize installments_paid as 0 (6 ms)
      Î“ÃªÃœ should initialize balance_remaining as amountFinanced (1 ms)
    Agreement Status
      Î“ÃªÃœ should support active status (1 ms)
      Î“ÃªÃœ should support completed status (1 ms)
      Î“ÃªÃœ should support defaulted status (6 ms)
      Î“ÃªÃœ should support cancelled status (1 ms)
      Î“ÃªÃœ should support suspended status (1 ms)
    Payment Processing
      Î“ÃªÃœ recordInstallmentPayment should accept payment data (1 ms)
      Î“ÃªÃœ should update installment status to paid (3 ms)
      Î“ÃªÃœ should track payment date (1 ms)
      Î“ÃªÃœ should increment installments_paid count (2 ms)
      Î“ÃªÃœ should update balance_remaining (1 ms)
    Installment Tracking
      Î“ÃªÃœ getOverdueInstallments should return overdue payments (2 ms)
      Î“ÃªÃœ getUpcomingInstallments should return upcoming payments (5 ms)
      Î“ÃªÃœ getUpcomingInstallments should default to 30 days ahead (2 ms)
      Î“ÃªÃœ getPaymentHistory should return installment payments (2 ms)
    Analytics Functions
      Î“ÃªÃœ getAgreementById should retrieve single agreement (2 ms)
      Î“ÃªÃœ listAgreements should list agreements for business (2 ms)
      Î“ÃªÃœ getAgreementSummary should return agreement statistics (2 ms)
      Î“ÃªÃœ getStatusDistribution should return count by status (2 ms)
      Î“ÃªÃœ getCollectionRate should calculate payment collection percentage (1 ms)
      Î“ÃªÃœ getRevenueByFrequency should return revenue by payment frequency (1 ms)
    Frequency Support
      Î“ÃªÃœ should support daily frequency
      Î“ÃªÃœ should support weekly frequency
      Î“ÃªÃœ should support monthly frequency
      Î“ÃªÃœ should support quarterly frequency (3 ms)
    Risk Management
      Î“ÃªÃœ should identify overdue payments (1 ms)
      Î“ÃªÃœ should flag defaulted agreements (1 ms)
      Î“ÃªÃœ should track collection rate (9 ms)
      Î“ÃªÃœ should support grace period (1 ms)
      Î“ÃªÃœ should support late fees (3 ms)
    List Operations
      Î“ÃªÃœ listAgreements should support business filtering (1 ms)
      Î“ÃªÃœ listAgreements should support pagination (3 ms)
      Î“ÃªÃœ listAgreements should support sorting (3 ms)
      Î“ÃªÃœ listAgreements should support status filtering (2 ms)

PASS tests/analytics.test.js
  Analytics Service
    Date Range Calculations
      Î“ÃªÃœ should calculate daily date range (291 ms)
      Î“ÃªÃœ should calculate weekly date range (2 ms)
      Î“ÃªÃœ should calculate monthly date range (10 ms)
      Î“ÃªÃœ should throw error for invalid period (108 ms)
    Total Sales Calculation
      Î“ÃªÃœ should calculate total sales for a period (3 ms)
      Î“ÃªÃœ should return zeros for no sales (3 ms)
    Profit Calculation
      Î“ÃªÃœ should calculate total profit (2 ms)
      Î“ÃªÃœ should calculate profit margin correctly (2 ms)
      Î“ÃªÃœ should return 0 margin when no revenue (5 ms)

PASS tests/myWallet.test.js (5.866 s)
  My Wallet Service
    getOrCreateWallet
      Î“ÃªÃœ should get existing wallet for business (2266 ms)
      Î“ÃªÃœ should throw error when business not found (157 ms)
      Î“ÃªÃœ should create wallet when not exists (17 ms)
    getWalletBalance
      Î“ÃªÃœ should return wallet balance with recent transactions (7 ms)
    getWalletTransactions
      Î“ÃªÃœ should return wallet transactions (12 ms)
      Î“ÃªÃœ should filter transactions by type (12 ms)
    getTokenPurchaseHistory
      Î“ÃªÃœ should return purchase history (8 ms)
      Î“ÃªÃœ should filter by status (3 ms)

PASS tests/spoiledStock.test.js
  Spoiled Stock Service
    Module Exports
      Î“ÃªÃœ should export recordSpoilage function (414 ms)
      Î“ÃªÃœ should export getSpoilageById function (3 ms)
      Î“ÃªÃœ should export listSpoilageRecords function (1 ms)
      Î“ÃªÃœ should export getSpoilageSummary function (2 ms)
      Î“ÃªÃœ should export getSpoilageByType function (2 ms)
      Î“ÃªÃœ should export getTopSpoiledProducts function (1 ms)
      Î“ÃªÃœ should export getHighestLossProducts function (2 ms)
      Î“ÃªÃœ should export getMonthlySpoilageTrend function (4 ms)
      Î“ÃªÃœ should export getHighestSpoilageRateProducts function (1 ms)
      Î“ÃªÃœ should export updateSpoilageRecord function (1 ms)
      Î“ÃªÃœ should export deleteSpoilageRecord function (4 ms)
    Function Signatures
      Î“ÃªÃœ recordSpoilage should be async (1 ms)
      Î“ÃªÃœ getSpoilageById should be async (1 ms)
      Î“ÃªÃœ listSpoilageRecords should be async (1 ms)
      Î“ÃªÃœ getSpoilageSummary should be async (1 ms)
      Î“ÃªÃœ getSpoilageByType should be async (1 ms)
      Î“ÃªÃœ getTopSpoiledProducts should be async
      Î“ÃªÃœ getHighestLossProducts should be async (12 ms)
      Î“ÃªÃœ getMonthlySpoilageTrend should be async (3 ms)
      Î“ÃªÃœ getHighestSpoilageRateProducts should be async (1 ms)
      Î“ÃªÃœ updateSpoilageRecord should be async (1 ms)
      Î“ÃªÃœ deleteSpoilageRecord should be async (7 ms)
    recordSpoilage Parameters
      Î“ÃªÃœ should accept businessId (1 ms)
      Î“ÃªÃœ should accept productId (1 ms)
      Î“ÃªÃœ should accept quantity (1 ms)
      Î“ÃªÃœ should accept spoilageType (1 ms)
      Î“ÃªÃœ should accept reason
      Î“ÃªÃœ should accept optional notes (1 ms)
      Î“ÃªÃœ should accept optional createdBy (1 ms)
      Î“ÃªÃœ should accept optional referenceType (2 ms)
      Î“ÃªÃœ should accept optional referenceId (1 ms)
    Spoilage Types
      Î“ÃªÃœ should validate spoilageType against SPOILAGE_TYPES (2 ms)
      Î“ÃªÃœ should support expiration type (10 ms)
      Î“ÃªÃœ should support damage type (1 ms)
      Î“ÃªÃœ should support storage type (2 ms)
      Î“ÃªÃœ should support handling type (1 ms)
      Î“ÃªÃœ should support theft type (2 ms)
      Î“ÃªÃœ should support other type (1 ms)
      Î“ÃªÃœ should throw error for invalid spoilageType (1 ms)
    Validation
      Î“ÃªÃœ should verify product exists (4 ms)
      Î“ÃªÃœ should verify user owns business (1 ms)
      Î“ÃªÃœ should verify spoiled quantity does not exceed available (1 ms)
      Î“ÃªÃœ should throw error if insufficient stock (2 ms)
    Loss Calculation
      Î“ÃªÃœ should calculate unitCost from product.buying_price_per_unit (2 ms)
      Î“ÃªÃœ should calculate totalLossValue (1 ms)
      Î“ÃªÃœ should use atomic transaction for spoilage and stock update (2 ms)
      Î“ÃªÃœ should update product current_quantity (1 ms)
    Analytics Functions
      Î“ÃªÃœ getSpoilageById should retrieve spoilage record by id
      Î“ÃªÃœ listSpoilageRecords should list all spoilage for business
      Î“ÃªÃœ getSpoilageSummary should return totals and breakdown (1 ms)
      Î“ÃªÃœ getSpoilageByType should filter by spoilage type (2 ms)
      Î“ÃªÃœ getTopSpoiledProducts should rank products by spoilage quantity (52 ms)
      Î“ÃªÃœ getHighestLossProducts should rank products by loss value (3 ms)
      Î“ÃªÃœ getMonthlySpoilageTrend should return trend over months (1 ms)
      Î“ÃªÃœ getHighestSpoilageRateProducts should rank by spoilage rate (1 ms)
    Update and Delete
      Î“ÃªÃœ updateSpoilageRecord should modify spoilage record (2 ms)
      Î“ÃªÃœ deleteSpoilageRecord should remove spoilage record (2 ms)
      Î“ÃªÃœ deleteS poilageRecord should reverse stock update (6 ms)
    Reference Types
      Î“ÃªÃœ should support stock_count reference type (2 ms)
      Î“ÃªÃœ should support delivery_check reference type (2 ms)
      Î“ÃªÃœ should support manual reference type (2 ms)
    Summary Statistics
      Î“ÃªÃœ getSpoilageSummary should include total quantity spoiled (3 ms)
      Î“ÃªÃœ getSpoilageSummary should include total loss value (2 ms)
      Î“ÃªÃœ getSpoilageSummary should include breakdown by type (2 ms)
      Î“ÃªÃœ getSpoilageSummary should include percentage by type (1 ms)
      Î“ÃªÃœ getSpoilageSummary should track number of incidents (2 ms)
    Trend Analysis
      Î“ÃªÃœ getMonthlySpoilageTrend should return month and quantities (12 ms)
      Î“ÃªÃœ getMonthlySpoilageTrend should include loss values (1 ms)
      Î“ÃªÃœ getHighestSpoilageRateProducts should calculate rate percentage (1 ms)

C:\Users\kkc12\payme\node_modules\drizzle-orm\pg-core\session.cjs:66
        throw new import_errors.DrizzleQueryError(queryString, params, e);
              ^

DrizzleQueryError: Failed query: select "id", "email", "name", "phone_number", "role", "created_at", "updated_at" from "users"
params: 
    at NeonHttpPreparedQuery.queryWithCache (C:\Users\kkc12\payme\node_modules\src\pg-core\session.ts:73:11)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at NeonHttpPreparedQuery.execute (C:\Users\kkc12\payme\node_modules\src\neon-http\session.ts:83:18)
    at getAllUsers (C:\Users\kkc12\payme\src\services\users.service.js:14:12) {
  query: 'select "id", "email", "name", "phone_number", "role", "created_at", "updated_at" from "users"',
  params: [],
  cause: NeonDbError: Error connecting to database: TypeError: fetch failed
      at mr.execute (C:\Users\kkc12\payme\node_modules\@neondatabase\serverless\index.js:1294:95)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)
      at C:\Users\kkc12\payme\node_modules\src\neon-http\session.ts:84:11
      at NeonHttpPreparedQuery.queryWithCache (C:\Users\kkc12\payme\node_modules\src\pg-core\session.ts:71:12)
      at NeonHttpPreparedQuery.execute (C:\Users\kkc12\payme\node_modules\src\neon-http\session.ts:83:18)
      at getAllUsers (C:\Users\kkc12\payme\src\services\users.service.js:14:12) {
    severity: undefined,
    code: undefined,
    detail: undefined,
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: undefined,
    table: undefined,
    column: undefined,
    dataType: undefined,
    constraint: undefined,
    file: undefined,
    line: undefined,
    routine: undefined,
    sourceError: TypeError: fetch failed
        at node:internal/deps/undici/undici:13510:13
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at mr.execute (C:\Users\kkc12\payme\node_modules\@neondatabase\serverless\index.js:1294:4)
        at C:\Users\kkc12\payme\node_modules\src\neon-http\session.ts:84:11
        at NeonHttpPreparedQuery.queryWithCache (C:\Users\kkc12\payme\node_modules\src\pg-core\session.ts:71:12)
        at NeonHttpPreparedQuery.execute (C:\Users\kkc12\payme\node_modules\src\neon-http\session.ts:83:18)
        at getAllUsers (C:\Users\kkc12\payme\src\services\users.service.js:14:12) {
      [cause]: AggregateError: 
          at internalConnectMultiple (node:net:1134:18)
          at afterConnectMultiple (node:net:1715:7) {
        code: 'ECONNREFUSED',
        [errors]: [
          Error: connect ECONNREFUSED ::1:443
              at createConnectionError (node:net:1678:14)
              at afterConnectMultiple (node:net:1708:16) {
            errno: -4078,
            code: 'ECONNREFUSED',
            syscall: 'connect',
            address: '::1',
            port: 443
          },
          Error: connect ECONNREFUSED 127.0.0.1:443
              at createConnectionError (node:net:1678:14)
              at afterConnectMultiple (node:net:1708:16) {
            errno: -4078,
            code: 'ECONNREFUSED',
            syscall: 'connect',
            address: '127.0.0.1',
            port: 443
          }
        ]
      }
    }
  }
}

Node.js v22.17.0
PASS tests/expense.test.js
  Expense Service
    Expense Recording
      Î“ÃªÃœ should record new expense (278 ms)
      Î“ÃªÃœ should validate required fields (286 ms)
      Î“ÃªÃœ should validate expense amount is positive (9 ms)
    Expense Categorization
      Î“ÃªÃœ should support multiple expense categories (5 ms)
    Expense Retrieval
      Î“ÃªÃœ should get expense by ID (3 ms)
      Î“ÃªÃœ should list expenses with filters (3 ms)
      Î“ÃªÃœ should filter expenses by category (4 ms)
      Î“ÃªÃœ should filter expenses by date range (2 ms)
    Expense Reporting
      Î“ÃªÃœ should get expense summary (3 ms)
      Î“ÃªÃœ should get expenses by category (7 ms)
      Î“ÃªÃœ should get expenses by payment method (2 ms)
      Î“ÃªÃœ should get monthly expense trend (2 ms)
      Î“ÃªÃœ should get top expenses (90 ms)
      Î“ÃªÃœ should get category breakdown (2 ms)
      Î“ÃªÃœ should get total expenses (4 ms)
      Î“ÃªÃœ should get expense status distribution (2 ms)
    Expense Update
      Î“ÃªÃœ should update expense details (1 ms)
    Expense Deletion
      Î“ÃªÃœ should delete expense (1 ms)
      Î“ÃªÃœ should handle deletion errors gracefully (1 ms)

PASS tests/paymentConfig.test.js (6.514 s)
  Payment Configuration Service
    Payment Config Creation
      Î“ÃªÃœ should create paybill payment configuration (1173 ms)
      Î“ÃªÃœ should create till payment configuration (15 ms)
      Î“ÃªÃœ should create pochi la biashara configuration (5 ms)
      Î“ÃªÃœ should validate shortcode format (193 ms)
      Î“ÃªÃœ should validate passkey is provided (3 ms)
    Payment Config Retrieval
      Î“ÃªÃœ should get payment config by business (3 ms)
      Î“ÃªÃœ should get payment config by ID (2 ms)
    Payment Config Activation
      Î“ÃªÃœ should activate payment config (2 ms)
      Î“ÃªÃœ should deactivate payment config (2 ms)
    Payment Config Update
      Î“ÃªÃœ should update payment config credentials (2 ms)
      Î“ÃªÃœ should validate updated credentials (2 ms)
    Payment Config Verification
      Î“ÃªÃœ should verify M-Pesa credentials (1735 ms)
    Payment Config Deletion
      Î“ÃªÃœ should delete payment config (2 ms)
      Î“ÃªÃœ should not delete active payment config (1 ms)
    Payment Methods Support
      Î“ÃªÃœ should support multiple payment methods (2 ms)

[31merror[39m: Token purchase STK push failed {"error":"Request failed with status code 400","service":"payme","timestamp":"2026-02-03T14:48:27.557Z"}
[31merror[39m: Token purchase STK push failed {"error":"Missing M-Pesa OAuth credentials (CONSUMER_KEY/CONSUMER_SECRET)","service":"payme","timestamp":"2026-02-03T14:48:27.561Z"}
PASS tests/audit.test.js
  Audit Service
    Module Exports
      Î“ÃªÃœ should export logAuditEvent function (424 ms)
      Î“ÃªÃœ should export getAuditLogs function (1 ms)
      Î“ÃªÃœ should export getEntityAuditLogs function (5 ms)
      Î“ÃªÃœ should export getUserAuditLogs function (8 ms)
      Î“ÃªÃœ should export getAuditSummary function (2 ms)
      Î“ÃªÃœ should export withAuditLogging function (89 ms)
    Function Signatures
      Î“ÃªÃœ logAuditEvent should be async
      Î“ÃªÃœ getAuditLogs should be async (1 ms)
      Î“ÃªÃœ getEntityAuditLogs should be async (1 ms)
      Î“ÃªÃœ getUserAuditLogs should be async (1 ms)
      Î“ÃªÃœ getAuditSummary should be async
      Î“ÃªÃœ withAuditLogging should return function (1 ms)
    logAuditEvent Parameters
      Î“ÃªÃœ should accept data object with businessId (1 ms)
      Î“ÃªÃœ should accept data object with userId (1 ms)
      Î“ÃªÃœ should accept data object with action
      Î“ÃªÃœ should accept data object with entityType (1 ms)
      Î“ÃªÃœ should accept data object with entityId (1 ms)
      Î“ÃªÃœ should support optional oldValues
      Î“ÃªÃœ should support optional newValues
      Î“ÃªÃœ should support optional metadata (1 ms)
      Î“ÃªÃœ should support optional ipAddress
      Î“ÃªÃœ should support optional userAgent (1 ms)
    getAuditLogs Parameters
      Î“ÃªÃœ should accept businessId as required parameter (2 ms)
      Î“ÃªÃœ should accept options object as second parameter (2 ms)
      Î“ÃªÃœ should support limit in options (default 100) (45 ms)
      Î“ÃªÃœ should support offset in options (default 0) (1 ms)
      Î“ÃªÃœ should support entityType filter in options (1 ms)
      Î“ÃªÃœ should support action filter in options (1 ms)
      Î“ÃªÃœ should support userId filter in options
      Î“ÃªÃœ should support startDate filter in options (1 ms)
      Î“ÃªÃœ should support endDate filter in options
    getEntityAuditLogs Parameters
      Î“ÃªÃœ should accept businessId parameter (1 ms)
      Î“ÃªÃœ should accept entityType parameter (1 ms)
      Î“ÃªÃœ should accept entityId parameter (1 ms)
    getUserAuditLogs Parameters
      Î“ÃªÃœ should accept businessId parameter (1 ms)
      Î“ÃªÃœ should accept userId parameter (1 ms)
      Î“ÃªÃœ should accept optional limit parameter (default 50) (1 ms)
    getAuditSummary Parameters
      Î“ÃªÃœ should accept businessId as required parameter (1 ms)
      Î“ÃªÃœ should accept optional days parameter (default 7) (1 ms)
    withAuditLogging Parameters
      Î“ÃªÃœ should accept handler function (1 ms)
      Î“ÃªÃœ should accept options with action property (1 ms)
      Î“ÃªÃœ should accept options with entityType property (1 ms)
      Î“ÃªÃœ should accept options with optional metadata (1 ms)
      Î“ÃªÃœ should accept options with optional oldValues (1 ms)
    Audit Actions
      Î“ÃªÃœ should support CREATE action (4 ms)
      Î“ÃªÃœ should support UPDATE action (102 ms)
      Î“ÃªÃœ should support DELETE action (1 ms)
      Î“ÃªÃœ should support READ action (1 ms)
      Î“ÃªÃœ should support EXPORT action
      Î“ÃªÃœ should support FAILED action suffix (72 ms)
    Summary Return Values
      Î“ÃªÃœ getAuditSummary should return period field (20 ms)
      Î“ÃªÃœ getAuditSummary should return totalEvents field (1 ms)
      Î“ÃªÃœ getAuditSummary should return byAction field (1 ms)
      Î“ÃªÃœ getAuditSummary should return byEntityType field (1 ms)
      Î“ÃªÃœ getAuditSummary should return topUsers field (3 ms)
      Î“ÃªÃœ topUsers should contain userId and events (1 ms)
      Î“ÃªÃœ topUsers should be limited to 5 entries (22 ms)

[31merror[39m: Business payment STK push failed {"error":"Business payment configuration is required. Please setup your M-Pesa credentials first.","service":"payme","timestamp":"2026-02-03T14:48:27.567Z"}
[31merror[39m: Business payment STK push failed {"error":"Payment configuration is inactive. Please activate in settings.","service":"payme","timestamp":"2026-02-03T14:48:27.573Z"}
[31merror[39m: B2C payout failed {"error":"Request failed with status code 400","service":"payme","timestamp":"2026-02-03T14:48:27.819Z"}
PASS tests/customer.test.js
  Customer Service
    Customer Creation
      Î“ÃªÃœ should create a new customer (496 ms)
    Customer Retrieval
      Î“ÃªÃœ should get customer by ID (2 ms)
    Customer Search
      Î“ÃªÃœ should search customers by name (4 ms)

[31merror[39m: B2C payout failed {"error":"Request failed with status code 400","service":"payme","timestamp":"2026-02-03T14:48:28.064Z"}
[31merror[39m: B2C payout failed {"error":"Request failed with status code 403","service":"payme","timestamp":"2026-02-03T14:48:28.136Z"}
PASS tests/mpesa.test.js (7.189 s)
  M-Pesa Integration
    Phone Number Normalization
      Î“ÃªÃœ should normalize phone number with plus sign (1305 ms)
      Î“ÃªÃœ should convert 254 to +254 format (2 ms)
      Î“ÃªÃœ should convert 0 prefix to +254 format (2 ms)
      Î“ÃªÃœ should handle 9-digit phone numbers (1 ms)
      Î“ÃªÃœ should throw error for null phone (167 ms)
    Response Formatting
      Î“ÃªÃœ should format successful M-Pesa response (4 ms)
      Î“ÃªÃœ should format failed response (2 ms)
      Î“ÃªÃœ should handle null response (4 ms)
    Constants Export
      Î“ÃªÃœ should export wallet paybill constant (2 ms)
      Î“ÃªÃœ should export wallet account reference constant (1 ms)
    Callback Validation
      Î“ÃªÃœ should validate successful callback (142 ms)
      Î“ÃªÃœ should validate failed callback (1 ms)
      Î“ÃªÃœ should validate callback signature (2 ms)
      Î“ÃªÃœ should validate callback timestamp (1 ms)
      Î“ÃªÃœ should validate callback structure (1 ms)
      Î“ÃªÃœ should sanitize callback data (2 ms)
      Î“ÃªÃœ should extract callback metadata (1 ms)
    STK Push - Validation
      Î“ÃªÃœ should validate phone parameter is required for token purchase (41 ms)
      Î“ÃªÃœ should validate amount parameter is required (4 ms)
      Î“ÃªÃœ should validate accountReference parameter is required (4 ms)
      Î“ÃªÃœ should throw error when MPESA_PASSKEY missing (1511 ms)
      Î“ÃªÃœ should throw error when consumer credentials missing (5 ms)
    Business Payment - Validation
      Î“ÃªÃœ should throw error when payment config is null (7 ms)
      Î“ÃªÃœ should throw error when payment config is inactive (4 ms)
    B2C Payout - Validation
      Î“ÃªÃœ should throw error when B2C initiator missing (245 ms)
      Î“ÃªÃœ should throw error when B2C security credential missing (245 ms)
      Î“ÃªÃœ should throw error when B2C shortcode missing (71 ms)

[32minfo[39m: Notification 1 created for user 1 {"service":"payme","timestamp":"2026-02-03T14:48:28.707Z"}
[32minfo[39m: In-app notification ready: 1 {"service":"payme","timestamp":"2026-02-03T14:48:28.721Z"}
[31merror[39m: Error creating notification User 999 not found {"service":"payme","stack":"Error: User 999 not found\n    at Object.createNotification (C:\\Users\\kkc12\\payme\\src\\services\\notification.service.js:56:15)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at Object.<anonymous> (C:\\Users\\kkc12\\payme\\tests\\notification.test.js:105:7)","timestamp":"2026-02-03T14:48:28.823Z"}
PASS tests/notification.test.js (7.839 s)
  Notification Service
    Notification Creation
      Î“ÃªÃœ should create a notification (4318 ms)
      Î“ÃªÃœ should throw error when user not found (106 ms)

PASS tests/businesses.test.js
  Businesses Service
    Business Creation
      Î“ÃªÃœ should create a new business for user (355 ms)
      Î“ÃªÃœ should validate business name is provided (27 ms)
    Business Retrieval
      Î“ÃªÃœ should get business by ID if user owns it (4 ms)
      Î“ÃªÃœ should throw error if user does not own business (10 ms)
      Î“ÃªÃœ should get all businesses for user (3 ms)
    Business Updates
      Î“ÃªÃœ should update business details (2 ms)

PASS tests/credit.test.js
  Credit Service
    Credit Accounts
      Î“ÃªÃœ should get credit account by ID (389 ms)
      Î“ÃªÃœ should throw error if account not found (64 ms)
      Î“ÃªÃœ should get all credit accounts for business (4 ms)
      Î“ÃªÃœ should update credit account (2 ms)
      Î“ÃªÃœ should deactivate credit account with zero balance (2 ms)
      Î“ÃªÃœ should throw error when deactivating account with outstanding balance (2 ms)
    Credit Sales
      Î“ÃªÃœ should get credit sales for account (2 ms)
      Î“ÃªÃœ should get credit sale with details (1 ms)
    Credit Payments
      Î“ÃªÃœ should get credit payments for account (2 ms)
    Credit Ledger
      Î“ÃªÃœ should get credit ledger for account (2 ms)
    Credit Reporting
      Î“ÃªÃœ should get credit summary for business (3 ms)
      Î“ÃªÃœ should get aging report for business (3 ms)
      Î“ÃªÃœ should get customer statement (2 ms)

PASS tests/record.test.js (11.83 s)
  Record Service
    Module Exports
      Î“ÃªÃœ should export createRecord function (8310 ms)
      Î“ÃªÃœ should export getRecordById function (1 ms)
      Î“ÃªÃœ should export getRecords function (1 ms)
      Î“ÃªÃœ should export getRecordsByDateRange function (1 ms)
      Î“ÃªÃœ should export calculateTotals function (2 ms)
      Î“ÃªÃœ should export processM2PesaCallback function (2 ms)
      Î“ÃªÃœ should export getDashboardInsights function (1 ms)
    Function Signatures
      Î“ÃªÃœ createRecord should be async (1 ms)
      Î“ÃªÃœ getRecordById should be async (1 ms)
      Î“ÃªÃœ getRecords should be async (1 ms)
      Î“ÃªÃœ getRecordsByDateRange should be async (1 ms)
      Î“ÃªÃœ calculateTotals should be async (1 ms)
      Î“ÃªÃœ processM2PesaCallback should be async (1 ms)
      Î“ÃªÃœ getDashboardInsights should be async (1 ms)
    createRecord Parameters
      Î“ÃªÃœ should accept object with business_id (1 ms)
      Î“ÃªÃœ should accept object with user_id (1 ms)
      Î“ÃªÃœ should accept object with type field (1 ms)
      Î“ÃªÃœ should accept object with category field (1 ms)
      Î“ÃªÃœ should accept object with amount field (1 ms)
      Î“ÃªÃœ should accept object with transaction_date field
      Î“ÃªÃœ should accept optional items array
      Î“ÃªÃœ should accept optional payment_method (1 ms)
      Î“ÃªÃœ should accept optional mpesa_data object (1 ms)
      Î“ÃªÃœ should accept optional reference_id for idempotency (1 ms)
      Î“ÃªÃœ should accept optional description field (1 ms)
      Î“ÃªÃœ should accept optional product_id field (1 ms)
      Î“ÃªÃœ should accept optional credit_due_date (1 ms)
    Record Types
      Î“ÃªÃœ should validate record type is one of allowed types
      Î“ÃªÃœ should support sales type
      Î“ÃªÃœ should support hp type (1 ms)
      Î“ÃªÃœ should support credit type (1 ms)
      Î“ÃªÃœ should support inventory type
      Î“ÃªÃœ should support expense type (1 ms)
    Validation
      Î“ÃªÃœ should throw error for invalid record type (1 ms)
      Î“ÃªÃœ should throw error if amount is not greater than 0
      Î“ÃªÃœ should throw error if insufficient tokens (1 ms)
      Î“ÃªÃœ should check wallet balance before deducting token
    Token Deduction (Revenue Guard)
      Î“ÃªÃœ should deduct exactly 1 token per record (1 ms)
      Î“ÃªÃœ should track token_deducted field
      Î“ÃªÃœ should use atomic transaction for token and record
      Î“ÃªÃœ should generate revenue_guard_reference (1 ms)
      Î“ÃªÃœ should not deduct token if record creation fails (1 ms)
    Idempotency
      Î“ÃªÃœ should prevent duplicate records with reference_id (1 ms)
      Î“ÃªÃœ should return existing record if reference_id already exists (1 ms)
      Î“ÃªÃœ should log warning when duplicate detected (1 ms)
    Google Sheets Sync
      Î“ÃªÃœ should sync record to Google Sheets if enabled (1 ms)
      Î“ÃªÃœ should set synced_to_sheets flag on success (1 ms)
      Î“ÃªÃœ should capture sync error but not fail request
      Î“ÃªÃœ should store sheets_sync_error if sync fails (1 ms)
    M-Pesa Integration
      Î“ÃªÃœ should accept mpesa_data object (1 ms)
      Î“ÃªÃœ should extract mpesaReceiptNumber from mpesa_data (1 ms)
      Î“ÃªÃœ should extract phoneNumber from mpesa_data
      Î“ÃªÃœ should extract transactionDate from mpesa_data (1 ms)
      Î“ÃªÃœ should extract transactionId from mpesa_data (1 ms)
    Line Items
      Î“ÃªÃœ should create line items if provided (1 ms)
      Î“ÃªÃœ should link items to record with record_id (1 ms)
      Î“ÃªÃœ should calculate total_amount for each item (1 ms)
      Î“ÃªÃœ should support cost_per_unit for items (1 ms)
    getRecordById Function
      Î“ÃªÃœ should accept business_id parameter (1 ms)
      Î“ÃªÃœ should accept record_id parameter (1 ms)
      Î“ÃªÃœ should return record with items included (1 ms)
    getRecords Function
      Î“ÃªÃœ should accept business_id parameter (1 ms)
      Î“ÃªÃœ should accept optional options object (1 ms)
    getRecordsByDateRange Function
      Î“ÃªÃœ should accept business_id parameter
      Î“ÃªÃœ should accept startDate parameter (1 ms)
      Î“ÃªÃœ should accept endDate parameter (1 ms)
      Î“ÃªÃœ should filter by date range
    calculateTotals Function
      Î“ÃªÃœ should accept business_id parameter
      Î“ÃªÃœ should calculate income total
      Î“ÃªÃœ should calculate expense total
      Î“ÃªÃœ should calculate net profit
    processM2PesaCallback Function
      Î“ÃªÃœ should accept callback data object (1 ms)
      Î“ÃªÃœ should process M-Pesa transaction reference (1 ms)
      Î“ÃªÃœ should update record status (1 ms)
    getDashboardInsights Function
      Î“ÃªÃœ should accept business_id parameter (1 ms)
      Î“ÃªÃœ should return summary statistics (1 ms)
      Î“ÃªÃœ should include income data (1 ms)
      Î“ÃªÃœ should include expense data (1 ms)
      Î“ÃªÃœ should include trend data (1 ms)
      Î“ÃªÃœ should include recent records (1 ms)
    Credit Records
      Î“ÃªÃœ should set credit_status to pending for credit type (1 ms)
      Î“ÃªÃœ should require credit_due_date for credit type
    M-Pesa Fields
      Î“ÃªÃœ should store mpesa_receipt_number
      Î“ÃªÃœ should store mpesa_sender_name (1 ms)
      Î“ÃªÃœ should store mpesa_sender_phone (1 ms)
      Î“ÃªÃœ should store mpesa_transaction_date (1 ms)
      Î“ÃªÃœ should store mpesa_transaction_id
      Î“ÃªÃœ should mark callback_processed if mpesa_data provided

PASS tests/googleSheets.test.js (12.001 s)
  Google Sheets Integration Service
    Exports Validation
      Î“ÃªÃœ should export getGoogleAuthUrl function (8297 ms)
      Î“ÃªÃœ should export exchangeAuthCode function (3 ms)
      Î“ÃªÃœ should export getOrCreateBusinessSheet function (2 ms)
      Î“ÃªÃœ should export syncRecordToGoogleSheets function (2 ms)
      Î“ÃªÃœ should export batchSyncRecords function (3 ms)
      Î“ÃªÃœ should export fetchRecordsFromGoogleSheets function (1 ms)
      Î“ÃªÃœ should have default export with all functions (2 ms)
    OAuth Configuration
      Î“ÃªÃœ should require GOOGLE_SHEETS_CLIENT_ID (2 ms)
      Î“ÃªÃœ should require GOOGLE_SHEETS_CLIENT_SECRET (2 ms)
      Î“ÃªÃœ should support GOOGLE_SHEETS_REDIRECT_URL configuration (2 ms)
      Î“ÃªÃœ should use default redirect URL if not provided (1 ms)
    Google Sheets Feature Flag
      Î“ÃªÃœ should respect GOOGLE_SHEETS_ENABLED flag (1 ms)
      Î“ÃªÃœ should sync when GOOGLE_SHEETS_ENABLED is true (1 ms)
      Î“ÃªÃœ should skip sync when GOOGLE_SHEETS_ENABLED is not set (2 ms)
    Function Signatures
      Î“ÃªÃœ getGoogleAuthUrl should be callable with no arguments (3 ms)
      Î“ÃªÃœ exchangeAuthCode should accept code string parameter (1 ms)
      Î“ÃªÃœ getOrCreateBusinessSheet should accept businessId and businessName (1 ms)
      Î“ÃªÃœ syncRecordToGoogleSheets should accept businessId, spreadsheetId, and record (1 ms)
      Î“ÃªÃœ batchSyncRecords should accept businessId, spreadsheetId, and records array (1 ms)
      Î“ÃªÃœ fetchRecordsFromGoogleSheets should accept businessId, spreadsheetId, and optional dateRange (1 ms)
    Service Structure
      Î“ÃªÃœ should have exactly 6 named exports (2 ms)
      Î“ÃªÃœ should be a valid ES module (1 ms)
    Async Functions
      Î“ÃªÃœ exchangeAuthCode should be async (10 ms)
      Î“ÃªÃœ getOrCreateBusinessSheet should be async (11 ms)
      Î“ÃªÃœ syncRecordToGoogleSheets should be async (2 ms)
      Î“ÃªÃœ batchSyncRecords should be async (1 ms)
      Î“ÃªÃœ fetchRecordsFromGoogleSheets should be async (8 ms)
    Parameter Validation
      Î“ÃªÃœ getOrCreateBusinessSheet should handle businessId parameter (3 ms)
      Î“ÃªÃœ syncRecordToGoogleSheets should handle all three parameters (184 ms)
      Î“ÃªÃœ batchSyncRecords should handle empty records array (1 ms)
      Î“ÃªÃœ fetchRecordsFromGoogleSheets should handle optional dateRange (2 ms)
      Î“ÃªÃœ exchangeAuthCode should handle code parameter (2 ms)
    Service Availability
      Î“ÃªÃœ should be importable from #services path (1 ms)
      Î“ÃªÃœ should have correct module path (1 ms)
    Google Sheets Scope Configuration
      Î“ÃªÃœ should have drive scope for file operations (1 ms)
      Î“ÃªÃœ should have spreadsheets scope for data operations (1 ms)
    OAuth URL Generation
      Î“ÃªÃœ getGoogleAuthUrl should return non-empty string (2 ms)
      Î“ÃªÃœ getGoogleAuthUrl should contain oauth2 endpoint (2 ms)
      Î“ÃªÃœ getGoogleAuthUrl should include access_type parameter (1 ms)
      Î“ÃªÃœ getGoogleAuthUrl should include scope parameter (1 ms)
    Service Account Support
      Î“ÃªÃœ should support service account authentication (1 ms)
      Î“ÃªÃœ should support refresh token caching (1 ms)
      Î“ÃªÃœ should support access token caching (1 ms)
    Record Format Support
      Î“ÃªÃœ syncRecordToGoogleSheets should support records with transaction_date (2 ms)
      Î“ÃªÃœ syncRecordToGoogleSheets should support records with M-Pesa fields (1 ms)
      Î“ÃªÃœ syncRecordToGoogleSheets should support records with items array (1 ms)
      Î“ÃªÃœ batchSyncRecords should accept multiple records (1 ms)
      Î“ÃªÃœ fetchRecordsFromGoogleSheets should return array of records (1 ms)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Test Suites: 19 passed, 19 total
Tests:       624 passed, 624 total
Snapshots:   0 total
Time:        13.305 s
Ran all test suites.
